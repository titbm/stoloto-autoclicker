# Обзор архитектуры расширения

## Введение

"Столото Автокликер" - это расширение Chrome, построенное на современной модульной архитектуре с использованием Manifest V3. Расширение предназначено для автоматического поиска и покупки билетов с заданными числами на сайте Столото. Архитектура основана на принципах модульности, где каждый модуль отвечает за конкретную область функциональности.

## Архитектурная схема

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   popup.html    │    │   popup.js      │    │  content.js     │
│   (UI)          │◄──►│ (UI Logic)      │◄──►│ (Entry Point)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  manifest.json  │    │  background.js  │    │ Chrome Storage  │
│ (Configuration) │    │ (Service Worker)│    │   (Data)        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
                        ┌─────────────────────────────────────────┐
                        │            Модульная система            │
                        │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
                        │  │main.js  │ │state.js │ │auth.js  │   │
                        │  └─────────┘ └─────────┘ └─────────┘   │
                        │  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
                        │  │search.js│ │ui.js    │ │payment.js│  │
                        │  └─────────┘ └─────────┘ └─────────┘   │
                        │  ┌─────────┐                           │
                        │  │utils.js │                           │
                        │  └─────────┘                           │
                        └─────────────────────────────────────────┘
```

## Компоненты расширения

### 1. manifest.json - Конфигурация расширения

**Назначение**: Основной конфигурационный файл, определяющий структуру, права доступа и поведение расширения.

**Ключевые характеристики**:
- **Manifest Version**: 3 (современная версия с улучшенной безопасностью)
- **Права доступа**: `activeTab`, `scripting`, `storage`, `tabs`
- **Content Scripts**: автоматически внедряется на страницу `https://www.stoloto.ru/ruslotto/game?viewType=favorite`
- **Service Worker**: `background.js` как фоновый процесс
- **Модульная загрузка**: определенный порядок загрузки модулей через content_scripts

**Конфигурация Manifest V3**:
```json
{
  "manifest_version": 3,
  "name": "Столото Автокликер",
  "version": "1.2.2",
  "permissions": ["activeTab", "scripting", "storage", "tabs"],
  "background": {
    "service_worker": "background.js",
    "type": "module"
  },
  "content_scripts": [{
    "matches": ["https://www.stoloto.ru/ruslotto/game?viewType=favorite"],
    "js": [
      "modules/utils.js",
      "modules/state.js", 
      "modules/ui.js",
      "modules/auth.js",
      "modules/payment.js", 
      "modules/search.js",
      "modules/main.js",
      "content.js"
    ]
  }]
}
```

**Права доступа**:
- `activeTab` - доступ к активной вкладке пользователя
- `scripting` - возможность внедрения скриптов в веб-страницы
- `storage` - использование Chrome Storage API для сохранения данных
- `tabs` - управление вкладками и отправка сообщений

**Порядок загрузки модулей**:
Модули загружаются в строго определенном порядке для обеспечения правильного разрешения зависимостей:
1. `utils.js` - вспомогательные функции
2. `state.js` - управление состоянием
3. `ui.js` - пользовательский интерфейс
4. `auth.js` - авторизация и баланс
5. `payment.js` - обработка платежей
6. `search.js` - поиск и анализ билетов
7. `main.js` - основная логика координации
8. `content.js` - точка входа

### 2. popup.html/popup.js - Пользовательский интерфейс

**Назначение**: Предоставление пользовательского интерфейса для настройки параметров поиска и управления расширением.

**Роль popup.html**:
- Определяет структуру пользовательского интерфейса
- Содержит элементы управления: поля ввода, кнопки, чекбоксы
- Предоставляет контейнеры для отображения предупреждений и статуса

**Роль popup.js**:
- Обработка пользовательского ввода и валидация данных
- Проверка авторизации пользователя на сайте Столото
- Управление режимом автоматической покупки билетов
- Проверка достаточности средств на балансе пользователя
- Сохранение и восстановление параметров последнего поиска

**Ключевые функции**:
- **Валидация чисел**: проверка диапазона 1-90, удаление дубликатов между полями поиска и исключений
- **Проверка авторизации**: через Chrome Storage и активную вкладку с кэшированием результатов
- **Управление балансом**: проверка достаточности средств для покупки с отображением предупреждений
- **Состояние поиска**: отслеживание активного/неактивного состояния с обновлением UI

**Взаимодействие с content script**:
```javascript
// Отправка команды на запуск поиска
chrome.tabs.sendMessage(activeTab.id, {
    action: 'clickNumbers',
    numbers: numbers,
    excludeNumbers: filteredExcludeNumbers,
    mode: searchMode.value,
    isPurchaseMode: isPurchaseMode,
    ticketsToBuy: ticketsToBuy
});

// Проверка авторизации пользователя
chrome.tabs.sendMessage(tab.id, { action: 'checkUserLogin' }, (response) => {
    if (response && response.isLoggedIn !== undefined) {
        isUserAuthenticated = response.isLoggedIn;
        updateAuthDependentUI();
    }
});
```

### 3. content.js - Точка входа и координатор модулей

**Назначение**: Служит точкой входа для расширения и координирует работу всех модулей на странице Столото.

**Основные функции**:
- Инициализация расширения при загрузке страницы
- Проверка загрузки всех необходимых модулей
- Настройка обработчика сообщений от popup
- Загрузка сохраненного состояния покупки
- Сохранение статуса авторизации при загрузке страницы

**Процесс инициализации**:
```javascript
document.addEventListener('DOMContentLoaded', () => {
    // Проверяем, что все модули загружены
    const requiredModules = ['stolotoState', 'stolotoAuth', 'stolotoUI', 
                           'stolotoUtils', 'stolotoPayment', 'stolotoSearch', 'stolotoMain'];
    const missingModules = requiredModules.filter(module => !window[module]);
    
    if (missingModules.length > 0) {
        console.error('Не загружены модули:', missingModules);
        return;
    }
    
    // Настраиваем обработчик сообщений
    window.stolotoMain.setupMessageListener();
    
    // Загружаем состояние покупки
    window.stolotoState.loadPurchaseState();
    
    // Сохраняем статус авторизации
    window.stolotoState.saveAuthStatus();
});
```

**Координация модулей**:
- Все модули экспортируют свои функции в глобальное пространство `window`
- content.js обеспечивает правильную последовательность инициализации
- Проверяет доступность всех необходимых модулей перед запуском
- Обрабатывает случаи, когда DOM уже загружен при выполнении скрипта

**Модульная архитектура**:
Вся логика работы с DOM разделена между специализированными модулями:
- `main.js` - основная логика поиска и координация
- `search.js` - анализ билетов и навигация
- `auth.js` - проверка авторизации и баланса
- `ui.js` - отображение статуса и предупреждений
- `payment.js` - обработка платежей
- `state.js` - управление состоянием
- `utils.js` - вспомогательные функции

### 4. background.js - Background Service Worker

**Назначение**: Service Worker, обрабатывающий события расширения и управляющий навигацией пользователя в соответствии с требованиями Manifest V3.

**Основные функции**:
- Обработка кликов по иконке расширения
- Автоматическое перенаправление на рабочую страницу Столото
- Управление отображением popup интерфейса
- Обеспечение правильной работы в событийной модели Service Worker

**Логика работы**:
```javascript
chrome.action.onClicked.addListener(async (tab) => {
    // URL рабочей страницы приложения
    const workPageUrl = 'https://www.stoloto.ru/ruslotto/game?viewType=favorite';
    
    // Если текущая вкладка - рабочая страница приложения
    if (tab.url === workPageUrl) {
        // Открываем popup
        await chrome.action.setPopup({ popup: 'popup.html' });
        // Имитируем повторный клик, чтобы открыть popup
        await chrome.action.openPopup();
    } else {
        // Если текущая вкладка не рабочая, открываем новую
        await chrome.tabs.create({ url: workPageUrl });
    }
    
    // Сбрасываем popup, чтобы следующий клик снова прошёл через этот обработчик
    await chrome.action.setPopup({ popup: '' });
});
```

**Особенности Service Worker**:
- **Событийная модель**: активируется только при необходимости
- **Ограниченное время жизни**: автоматически завершается при неактивности
- **Отсутствие DOM**: не имеет доступа к DOM, работает только с Chrome APIs
- **Модульная поддержка**: объявлен как `"type": "module"` в manifest.json

## Модульная система

### Принципы модульной архитектуры

Расширение построено на принципах модульной архитектуры, где каждый модуль отвечает за конкретную область функциональности:

**Преимущества модульной архитектуры**:
- **Разделение ответственности**: каждый модуль имеет четко определенную роль
- **Переиспользование кода**: функции могут использоваться разными модулями
- **Упрощение тестирования**: каждый модуль может тестироваться независимо
- **Легкость сопровождения**: изменения в одном модуле не влияют на другие

### Структура модулей

```
modules/
├── utils.js      - Вспомогательные функции общего назначения
├── state.js      - Управление глобальным состоянием приложения
├── ui.js         - Управление пользовательским интерфейсом
├── auth.js       - Авторизация и работа с балансом пользователя
├── payment.js    - Обработка платежей и покупок
├── search.js     - Поиск и анализ билетов
└── main.js       - Основная логика координации и обработка сообщений
```

### Система экспорта

Каждый модуль экспортирует свои функции в глобальное пространство `window`:

```javascript
// Пример из auth.js
window.stolotoAuth = {
    isUserLoggedIn,
    getUserBalance,
    hasEnoughFunds
};

// Пример из state.js
window.stolotoState = {
    ...window.stolotoState,  // Сохраняем существующие свойства состояния
    savePurchaseState,
    loadPurchaseState,
    resetPurchaseState,
    saveAuthStatus
};
```

### Зависимости между модулями

Модули имеют четкую иерархию зависимостей:

1. **utils.js** - не зависит от других модулей
2. **state.js** - использует utils.js для форматирования времени
3. **ui.js** - использует state.js и utils.js
4. **auth.js** - независимый модуль
5. **payment.js** - независимый модуль
6. **search.js** - использует state.js, ui.js, auth.js, payment.js, utils.js
7. **main.js** - использует все предыдущие модули

## Жизненный цикл расширения

### 1. Установка и инициализация

1. **Установка расширения**: Chrome регистрирует расширение и его компоненты
2. **Регистрация Service Worker**: `event_page.js` становится активным фоновым процессом
3. **Настройка Content Scripts**: автоматическое внедрение `content.js` на целевую страницу
4. **Инициализация хранилища**: подготовка Chrome Storage для сохранения данных

### 2. Активация пользователем

1. **Клик по иконке**: пользователь нажимает на иконку расширения в панели инструментов
2. **Проверка URL**: `event_page.js` проверяет, находится ли пользователь на рабочей странице
3. **Навигация**: при необходимости открывается новая вкладка с рабочей страницей
4. **Отображение popup**: показывается интерфейс `popup.html` с логикой `popup.js`

### 3. Настройка и запуск поиска

1. **Ввод параметров**: пользователь вводит числа для поиска и настройки
2. **Валидация**: `popup.js` проверяет корректность введенных данных и удаляет дубликаты
3. **Проверка авторизации**: для режима покупки проверяется статус авторизации через `checkActiveTabAuth()`
4. **Проверка баланса**: при покупке проверяется достаточность средств через `checkUserBalance()`
5. **Отправка команды**: параметры передаются в `main.js` через Chrome messaging API

### 4. Выполнение поиска

1. **Получение команды**: `main.js` получает сообщение от popup через `setupMessageListener()`
2. **Инициализация состояния**: обновление `window.stolotoState` с параметрами поиска
3. **Очистка выбора**: `search.js` очищает предыдущий выбор через `clearSelection()`
4. **Выбор чисел**: `main.js` выполняет автоматический клик по числам на странице
5. **Загрузка билетов**: нажатие кнопки "Показать билеты"
6. **Анализ результатов**: `search.js` проверяет каждый билет через `analyzeTicket()`
7. **Обновление UI**: `ui.js` отображает прогресс через `updateStatusBlock()`
8. **Навигация**: переход к следующим билетам через кнопку "Другие билеты"

### 5. Завершение и результат

1. **Обнаружение совпадения**: `search.js` находит билет, соответствующий критериям через `analyzeTicket()`
2. **Выбор билета**: автоматический клик по подходящему билету
3. **Покупка** (опционально): 
   - `payment.js` проверяет наличие кнопок оплаты через `checkPaymentButtons()`
   - Автоматическое нажатие кнопки "Оплатить кошельком"
   - Обновление счетчика купленных билетов в `state.js`
4. **Обновление статуса**: `ui.js` отображает результаты через `updateStatusBlock()`
5. **Сохранение состояния**: `state.js` записывает результаты в Chrome Storage через `savePurchaseState()`

### 6. Восстановление после перезагрузки

1. **Загрузка состояния**: `state.js` проверяет сохраненное состояние через `loadPurchaseState()`
2. **Валидация авторизации**: `auth.js` проверяет, что пользователь все еще авторизован
3. **Валидация данных**: проверка актуальности сохраненных параметров покупки
4. **Продолжение процесса**: автоматическое возобновление поиска через `main.js`
5. **Обновление интерфейса**: `ui.js` восстанавливает отображение статуса

## Особенности Manifest V3

### Service Workers вместо Background Pages

- **Событийная модель**: Service Worker активируется только при необходимости
- **Улучшенная производительность**: меньшее потребление ресурсов
- **Ограниченное время жизни**: автоматическое завершение при неактивности

### Улучшенная безопасность

- **Ограниченные права**: минимальный набор необходимых разрешений
- **Content Security Policy**: защита от внедрения вредоносного кода
- **Изолированные контексты**: разделение между различными компонентами

### Современные API

- **chrome.action**: замена chrome.browserAction и chrome.pageAction
- **chrome.scripting**: улучшенное внедрение скриптов
- **Promises**: поддержка современного асинхронного кода

## Безопасность и ограничения

### Права доступа

Расширение запрашивает минимально необходимые права:
- Доступ только к активной вкладке (не ко всем сайтам)
- Ограниченное использование Chrome APIs
- Работа только на указанном домене Столото

### Обработка ошибок

- Graceful degradation при недоступности API
- Восстановление состояния после сбоев
- Валидация всех пользовательских данных
- Таймауты для предотвращения зависания

### Конфиденциальность

- Локальное хранение данных (Chrome Storage)
- Отсутствие передачи данных на внешние серверы
- Минимальное логирование пользовательских действий