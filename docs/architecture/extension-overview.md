# Обзор архитектуры расширения

## Введение

"Столото Автокликер" - это расширение Chrome, построенное на архитектуре Manifest V3, предназначенное для автоматического поиска и покупки билетов с заданными числами на сайте Столото. Расширение состоит из четырех основных компонентов, каждый из которых выполняет специфические функции в рамках общей архитектуры.

## Архитектурная схема

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   popup.html    │    │   popup.js      │    │  content.js     │
│   (UI)          │◄──►│ (UI Logic)      │◄──►│ (Page Logic)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  manifest.json  │    │  event_page.js  │    │ Chrome Storage  │
│ (Configuration) │    │ (Background)    │    │   (Data)        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Компоненты расширения

### 1. manifest.json - Конфигурация расширения

**Назначение**: Основной конфигурационный файл, определяющий структуру, права доступа и поведение расширения.

**Ключевые характеристики**:
- **Manifest Version**: 3 (современная версия с улучшенной безопасностью)
- **Права доступа**: `activeTab`, `scripting`, `storage`, `tabs`
- **Content Scripts**: автоматически внедряется на страницу `https://www.stoloto.ru/ruslotto/game?viewType=favorite`
- **Service Worker**: `event_page.js` как фоновый процесс

**Конфигурация Manifest V3**:
```json
{
  "manifest_version": 3,
  "name": "Столото Автокликер",
  "version": "1.2.2",
  "permissions": ["activeTab", "scripting", "storage", "tabs"],
  "background": {
    "service_worker": "event_page.js",
    "type": "module"
  },
  "content_scripts": [{
    "matches": ["https://www.stoloto.ru/ruslotto/game?viewType=favorite"],
    "js": ["content.js"]
  }]
}
```

**Права доступа**:
- `activeTab` - доступ к активной вкладке пользователя
- `scripting` - возможность внедрения скриптов в веб-страницы
- `storage` - использование Chrome Storage API для сохранения данных
- `tabs` - управление вкладками и отправка сообщений

### 2. popup.js - Интерфейс пользователя

**Назначение**: Обработка пользовательского ввода, валидация данных и управление состоянием интерфейса расширения.

**Основные функции**:
- Сбор и валидация пользовательского ввода (числа для поиска, режим поиска)
- Проверка авторизации пользователя на сайте Столото
- Управление режимом автоматической покупки билетов
- Проверка достаточности средств на балансе пользователя
- Сохранение и восстановление параметров последнего поиска

**Ключевые компоненты**:
- **Валидация чисел**: проверка диапазона 1-90, удаление дубликатов
- **Проверка авторизации**: через Chrome Storage и активную вкладку
- **Управление балансом**: проверка достаточности средств для покупки
- **Состояние поиска**: отслеживание активного/неактивного состояния

**Взаимодействие с другими компонентами**:
```javascript
// Отправка команды на content.js
chrome.tabs.sendMessage(activeTab.id, {
    action: 'clickNumbers',
    numbers: numbers,
    excludeNumbers: filteredExcludeNumbers,
    mode: searchMode.value,
    isPurchaseMode: isPurchaseMode,
    ticketsToBuy: ticketsToBuy
});
```

### 3. content.js - Основная логика работы

**Назначение**: Выполнение автоматических действий на странице Столото, включая поиск билетов, анализ результатов и совершение покупок.

**Основные функции**:
- Автоматический выбор чисел на странице
- Анализ билетов по заданным критериям (режимы: anywhere, half, row)
- Навигация между страницами билетов
- Автоматическая покупка подходящих билетов
- Отображение статуса поиска пользователю

**Алгоритмы поиска**:
- **anywhere**: поиск чисел в любом месте билета
- **half**: поиск в верхней (строки 1-3) или нижней (строки 4-6) половине
- **row**: поиск всех чисел в одной строке билета

**Состояние и персистентность**:
- Сохранение прогресса поиска в Chrome Storage
- Восстановление состояния после перезагрузки страницы
- Отслеживание количества проверенных билетов и времени поиска

**Анти-блокировочные механизмы**:
- Случайные задержки между действиями (250-1000мс)
- Имитация человеческого поведения при кликах
- Обработка ошибок сети и таймаутов

### 4. event_page.js - Фоновый сервис

**Назначение**: Service Worker, обрабатывающий события расширения и управляющий навигацией пользователя.

**Основные функции**:
- Обработка кликов по иконке расширения
- Автоматическое перенаправление на рабочую страницу Столото
- Управление отображением popup интерфейса

**Логика работы**:
```javascript
chrome.action.onClicked.addListener(async (tab) => {
    const workPageUrl = 'https://www.stoloto.ru/ruslotto/game?viewType=favorite';
    
    if (tab.url === workPageUrl) {
        // Открываем popup на рабочей странице
        await chrome.action.openPopup();
    } else {
        // Перенаправляем на рабочую страницу
        await chrome.tabs.create({ url: workPageUrl });
    }
});
```

## Жизненный цикл расширения

### 1. Установка и инициализация

1. **Установка расширения**: Chrome регистрирует расширение и его компоненты
2. **Регистрация Service Worker**: `event_page.js` становится активным фоновым процессом
3. **Настройка Content Scripts**: автоматическое внедрение `content.js` на целевую страницу
4. **Инициализация хранилища**: подготовка Chrome Storage для сохранения данных

### 2. Активация пользователем

1. **Клик по иконке**: пользователь нажимает на иконку расширения в панели инструментов
2. **Проверка URL**: `event_page.js` проверяет, находится ли пользователь на рабочей странице
3. **Навигация**: при необходимости открывается новая вкладка с рабочей страницей
4. **Отображение popup**: показывается интерфейс `popup.html` с логикой `popup.js`

### 3. Настройка и запуск поиска

1. **Ввод параметров**: пользователь вводит числа для поиска и настройки
2. **Валидация**: `popup.js` проверяет корректность введенных данных
3. **Проверка авторизации**: для режима покупки проверяется статус авторизации
4. **Проверка баланса**: при покупке проверяется достаточность средств
5. **Отправка команды**: параметры передаются в `content.js` через Chrome messaging API

### 4. Выполнение поиска

1. **Инициализация**: `content.js` получает команду и инициализирует поиск
2. **Выбор чисел**: автоматический клик по числам на странице
3. **Загрузка билетов**: нажатие кнопки "Показать билеты"
4. **Анализ результатов**: проверка каждого билета по заданным критериям
5. **Навигация**: переход к следующим билетам при необходимости

### 5. Завершение и результат

1. **Обнаружение совпадения**: найден билет, соответствующий критериям
2. **Выбор билета**: автоматический клик по подходящему билету
3. **Покупка** (опционально): автоматическая оплата через кошелек
4. **Обновление статуса**: отображение результатов пользователю
5. **Сохранение состояния**: запись результатов в Chrome Storage

### 6. Восстановление после перезагрузки

1. **Загрузка состояния**: `content.js` проверяет сохраненное состояние при загрузке страницы
2. **Валидация данных**: проверка актуальности сохраненных параметров
3. **Продолжение процесса**: автоматическое возобновление поиска или покупки
4. **Обновление интерфейса**: восстановление отображения статуса

## Особенности Manifest V3

### Service Workers вместо Background Pages

- **Событийная модель**: Service Worker активируется только при необходимости
- **Улучшенная производительность**: меньшее потребление ресурсов
- **Ограниченное время жизни**: автоматическое завершение при неактивности

### Улучшенная безопасность

- **Ограниченные права**: минимальный набор необходимых разрешений
- **Content Security Policy**: защита от внедрения вредоносного кода
- **Изолированные контексты**: разделение между различными компонентами

### Современные API

- **chrome.action**: замена chrome.browserAction и chrome.pageAction
- **chrome.scripting**: улучшенное внедрение скриптов
- **Promises**: поддержка современного асинхронного кода

## Безопасность и ограничения

### Права доступа

Расширение запрашивает минимально необходимые права:
- Доступ только к активной вкладке (не ко всем сайтам)
- Ограниченное использование Chrome APIs
- Работа только на указанном домене Столото

### Обработка ошибок

- Graceful degradation при недоступности API
- Восстановление состояния после сбоев
- Валидация всех пользовательских данных
- Таймауты для предотвращения зависания

### Конфиденциальность

- Локальное хранение данных (Chrome Storage)
- Отсутствие передачи данных на внешние серверы
- Минимальное логирование пользовательских действий