# Валидация и фильтрация чисел

## Обзор

Система валидации и фильтрации чисел в расширении "Столото Автокликер" обеспечивает корректную обработку пользовательского ввода, валидацию диапазонов чисел и управление конфликтами между поисковыми и исключающими числами.

## Парсинг чисел из пользовательского ввода

### Функция parseNumbers()

Основная функция для обработки пользовательского ввода находится в `popup.js`:

```javascript
function parseNumbers(input) {
    return input.split(',')
        .map(num => num.trim())
        .filter(num => {
            const n = parseInt(num);
            return !isNaN(n) && n >= 1 && n <= 90;
        });
}
```

### Алгоритм парсинга

1. **Разделение строки**: Входная строка разделяется по запятым
2. **Очистка пробелов**: Каждый элемент очищается от начальных и конечных пробелов
3. **Валидация формата**: Проверяется, что элемент может быть преобразован в число
4. **Валидация диапазона**: Проверяется, что число находится в диапазоне 1-90
5. **Фильтрация**: Возвращаются только валидные числа

### Примеры обработки ввода

| Входная строка | Результат | Комментарий |
|----------------|-----------|-------------|
| `"5, 12, 25, 45"` | `[5, 12, 25, 45]` | Корректный ввод |
| `"5,12,25,45"` | `[5, 12, 25, 45]` | Без пробелов |
| `"  5 , 12  , 25 "` | `[5, 12, 25]` | С лишними пробелами |
| `"5, abc, 25"` | `[5, 25]` | Некорректное значение отфильтровано |
| `"0, 5, 91, 25"` | `[5, 25]` | Числа вне диапазона отфильтрованы |
| `"5.5, 12, 25"` | `[12, 25]` | Дробные числа отфильтрованы |

## Валидация диапазона чисел

### Диапазон чисел Русского лото

- **Минимальное значение**: 1
- **Максимальное значение**: 90
- **Общее количество чисел**: 90

### Логика валидации диапазона

```javascript
const n = parseInt(num);
return !isNaN(n) && n >= 1 && n <= 90;
```

**Проверки**:
1. `!isNaN(n)` - число успешно распарсено
2. `n >= 1` - число не меньше минимального значения
3. `n <= 90` - число не больше максимального значения

### Обработка граничных случаев

| Значение | Результат | Причина |
|----------|-----------|---------|
| `0` | Отклонено | Меньше минимума |
| `1` | Принято | Минимальное значение |
| `90` | Принято | Максимальное значение |
| `91` | Отклонено | Больше максимума |
| `-5` | Отклонено | Отрицательное число |
| `"abc"` | Отклонено | Не число |
| `""` | Отклонено | Пустая строка |
| `null` | Отклонено | Null значение |

## Обработка дубликатов

### Функция removeDuplicateNumbers()

Функция обнаруживает и устраняет конфликты между поисковыми и исключающими числами:

```javascript
function removeDuplicateNumbers(numbers, excludeNumbers) {
    // Находим дубликаты
    const duplicates = numbers.filter(num => excludeNumbers.includes(num));
    
    // Если дубликаты найдены, удаляем их из списка исключений
    if (duplicates.length > 0) {
        // Создаем новый массив без дублирующихся чисел
        const filteredExcludeNumbers = excludeNumbers.filter(num => !numbers.includes(num));
        
        // Обновляем поле ввода исключений
        excludeNumbersInput.value = filteredExcludeNumbers.join(', ');
        
        // Визуально выделяем поле ввода исключений
        highlightExcludeInput();
        
        return {
            hasDuplicates: true,
            duplicates: duplicates,
            filteredExcludeNumbers: filteredExcludeNumbers
        };
    }
    
    return {
        hasDuplicates: false,
        duplicates: [],
        filteredExcludeNumbers: excludeNumbers
    };
}
```

### Алгоритм устранения дубликатов

1. **Поиск пересечений**: Находит числа, присутствующие в обоих массивах
2. **Приоритет поиска**: Поисковые числа имеют приоритет над исключающими
3. **Фильтрация исключений**: Удаляет дублирующиеся числа из списка исключений
4. **Обновление интерфейса**: Автоматически обновляет поле ввода исключений
5. **Визуальная индикация**: Подсвечивает измененное поле

### Примеры обработки дубликатов

| Поисковые числа | Исключающие числа | Результат исключений | Дубликаты |
|-----------------|-------------------|---------------------|-----------|
| `[5, 12, 25]` | `[12, 45, 67]` | `[45, 67]` | `[12]` |
| `[5, 12, 25]` | `[30, 45, 67]` | `[30, 45, 67]` | `[]` |
| `[5, 12, 25]` | `[5, 12, 25]` | `[]` | `[5, 12, 25]` |

## Система фильтрации исключающих чисел

### Логика применения исключений

В функции `analyzeTicket()` исключающие числа проверяются перед основным поиском:

```javascript
// Получаем все числа из билета
const ticketNumbers = rows
    .flat()
    .map(num => parseInt(num.textContent.trim()))
    .filter(num => !isNaN(num));

// Проверяем, нет ли исключаемых чисел в билете
if (excludeNumbers.length > 0) {
    const hasExcluded = excludeNumbers.some(num => ticketNumbers.includes(parseInt(num)));
    if (hasExcluded) {
        console.log('❌ В билете найдены исключаемые числа');
        return false;
    }
}
```

### Алгоритм фильтрации

1. **Извлечение чисел билета**: Получает все числа из текущего билета
2. **Проверка наличия исключений**: Проверяет, есть ли исключающие числа
3. **Поиск пересечений**: Ищет совпадения между числами билета и исключениями
4. **Раннее завершение**: При обнаружении исключенного числа сразу отклоняет билет
5. **Логирование**: Записывает информацию об отклонении в консоль

### Приоритет исключений

Исключающие числа имеют **абсолютный приоритет** над поисковыми:

- Если билет содержит все поисковые числа, но также содержит хотя бы одно исключающее число, билет **отклоняется**
- Проверка исключений выполняется **до** проверки поисковых чисел для оптимизации производительности

## Обработка конфликтов

### Типы конфликтов

1. **Прямые дубликаты**: Одно и то же число в поисковых и исключающих списках
2. **Логические конфликты**: Поиск числа при его одновременном исключении
3. **Пустые результаты**: Исключение всех поисковых чисел

### Стратегия разрешения конфликтов

```javascript
// Проверка на дублирование чисел между полями поиска и исключений
const duplicateCheck = removeDuplicateNumbers(numbers, excludeNumbers);
if (duplicateCheck.hasDuplicates) {
    console.log(`Обнаружены и удалены дублирующиеся числа: ${duplicateCheck.duplicates.join(', ')}`);
}

// Используем отфильтрованный список исключений
const filteredExcludeNumbers = duplicateCheck.filteredExcludeNumbers;
```

**Принципы разрешения**:
1. **Приоритет поиска**: Поисковые числа сохраняются
2. **Автоматическое исправление**: Дубликаты удаляются из исключений
3. **Уведомление пользователя**: Визуальная индикация изменений
4. **Логирование**: Запись действий в консоль

## Визуальная индикация изменений

### Функция highlightExcludeInput()

```javascript
function highlightExcludeInput() {
    // Сохраняем оригинальный стиль
    const originalBorder = excludeNumbersInput.style.border;
    
    // Подсвечиваем красным
    excludeNumbersInput.style.border = '2px solid #f44336';
    
    // Восстанавливаем через 1 секунду
    setTimeout(() => {
        excludeNumbersInput.style.border = originalBorder;
    }, 1000);
}
```

### Цели визуальной индикации

1. **Привлечение внимания**: Пользователь видит, что произошли изменения
2. **Обратная связь**: Подтверждение автоматического исправления
3. **Временность**: Эффект исчезает через 1 секунду
4. **Неинвазивность**: Не блокирует работу пользователя

## Валидация перед запуском поиска

### Проверка корректности ввода

```javascript
// Проверка на валидность чисел
if (numbers.length === 0) {
    alert('Пожалуйста, введите корректные числа от 1 до 90');
    button.disabled = false;
    return;
}
```

### Последовательность валидации

1. **Парсинг входных данных**: Обработка строк ввода
2. **Устранение дубликатов**: Разрешение конфликтов
3. **Проверка наличия чисел**: Убеждение, что есть числа для поиска
4. **Сохранение параметров**: Запись валидных данных в хранилище
5. **Запуск поиска**: Передача данных в content script

## Интеграция с хранилищем

### Сохранение валидированных данных

```javascript
// Сохраняем параметры поиска
await saveSearchParams(numbers, filteredExcludeNumbers, searchMode.value, isPurchaseMode, ticketsToBuy);
```

### Структура сохраняемых данных

```javascript
{
    lastSearch: {
        numbers: [5, 12, 25, 45],           // Валидированные поисковые числа
        excludeNumbers: [67, 89],           // Отфильтрованные исключения
        mode: 'half',                       // Режим поиска
        isPurchaseMode: false,              // Режим покупки
        ticketsToBuy: 1,                    // Количество билетов
        timestamp: 1640995200000            // Время сохранения
    }
}
```

## Обработка ошибок

### Типы ошибок валидации

1. **Некорректный формат**: Нечисловые значения
2. **Выход за диапазон**: Числа < 1 или > 90
3. **Пустой ввод**: Отсутствие валидных чисел
4. **Системные ошибки**: Ошибки парсинга или хранилища

### Стратегии обработки ошибок

```javascript
try {
    const numbers = parseNumbers(numbersInput.value);
    const excludeNumbers = parseNumbers(excludeNumbersInput.value);
    
    // Дальнейшая обработка...
} catch (error) {
    console.error('Ошибка при обработке чисел:', error);
    alert('Произошла ошибка при обработке введенных чисел');
}
```

**Принципы обработки**:
1. **Graceful degradation**: Продолжение работы с валидными данными
2. **Информирование пользователя**: Четкие сообщения об ошибках
3. **Логирование**: Запись ошибок для отладки
4. **Восстановление**: Возможность повторной попытки

## Производительность валидации

### Оптимизации

1. **Ранняя фильтрация**: Отсев невалидных значений на этапе парсинга
2. **Кэширование результатов**: Сохранение валидированных данных
3. **Минимизация DOM операций**: Обновление интерфейса только при необходимости
4. **Асинхронная обработка**: Неблокирующая валидация

### Метрики производительности

- Время парсинга строки из 10 чисел: < 1мс
- Время устранения дубликатов: < 1мс
- Время валидации диапазона: < 1мс
- Общее время валидации: < 5мс

## Тестирование валидации

### Тестовые случаи

1. **Позитивные тесты**: Корректные входные данные
2. **Негативные тесты**: Некорректные форматы и значения
3. **Граничные случаи**: Минимальные и максимальные значения
4. **Стресс-тесты**: Большие объемы данных
5. **Интеграционные тесты**: Взаимодействие с другими компонентами

### Примеры тестовых данных

```javascript
// Позитивные тесты
testParseNumbers("1,2,3,4,5", [1,2,3,4,5]);
testParseNumbers("1, 2, 3, 4, 5", [1,2,3,4,5]);

// Негативные тесты
testParseNumbers("0,1,2", [1,2]);
testParseNumbers("1,91,2", [1,2]);
testParseNumbers("a,b,c", []);

// Граничные случаи
testParseNumbers("1", [1]);
testParseNumbers("90", [90]);
testParseNumbers("1,90", [1,90]);
```