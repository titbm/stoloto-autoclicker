# Потоки пользовательского взаимодействия на сайте Столото

## Обзор

Данный документ описывает полные пользовательские сценарии взаимодействия с сайтом Столото в режиме "Свои числа", основанные на анализе реального поведения сайта и сравнении с логикой расширения.

## Основной поток: Выбор любимых чисел и поиск билетов

### 1. Начальное состояние страницы

**URL**: `https://www.stoloto.ru/ruslotto/game?viewType=favorite`

**Элементы интерфейса:**
- Заголовок "Русское лото"
- Информация о тиражах с джекпотами
- Навигационное меню с вкладками
- Инструкция: "Выберите до 7 любимых чисел — подберём с ними билеты"
- Сетка чисел от 1 до 90 (9×10)
- Боковая панель с информацией "Выберите билет"

**Состояние элементов:**
- Все кнопки чисел неактивны
- Кнопка "Показать билеты" отсутствует
- Кнопка "Сбросить" отсутствует

### 2. Выбор чисел пользователем

**Действие**: Клик по кнопке числа (например, "7")

**Изменения в интерфейсе:**
```
ДО:  <button data-test-id="number">7</button>
ПОСЛЕ: <button data-test-id="number" active>7</button>
```

**Появляющиеся элементы:**
- Блок "Выбранные числа" с отображением выбранного числа
- Кнопка "Сбросить" с иконкой
- Кнопка "Показать билеты" с иконкой

**Селекторы новых элементов:**
```javascript
// Блок выбранных чисел
const selectedBlock = document.querySelector('generic'); // содержит "Выбранные числа"

// Кнопка сброса
const resetBtn = document.querySelector('[data-test-id="clear_btn"]');

// Кнопка показа билетов  
const showBtn = document.querySelector('[data-test-id="other_ticket"]');
```

### 3. Поиск билетов

**Действие**: Клик по кнопке "Показать билеты"

**Процесс загрузки:**
- Задержка ~1 секунда
- Интерфейс выбора чисел заменяется на список билетов

**Изменения в интерфейсе:**
- Исчезает сетка чисел 1-90
- Появляется компактный блок "Выбранные числа: 7"
- Отображается список из 10 билетов
- Появляется кнопка "Другие билеты"

### 4. Отображение результатов поиска

**Структура билета:**
```html
<button class="Ticket_btn__L4SXA">
  <generic>
    <generic data-test-id="ticket-number">Билет №999294006725</generic>
    <img> <!-- Иконка -->
  </generic>
  <generic>
    <!-- Строка 1: 5 чисел -->
    <generic>8</generic>
    <generic>22</generic>
    <generic>46</generic>
    <generic>69</generic>
    <generic>90</generic>
    <!-- Строка 2: 5 чисел -->
    <generic>29</generic>
    <generic>42</generic>
    <generic>55</generic>
    <generic>79</generic>
    <generic>81</generic>
    <!-- ... остальные 4 строки -->
  </generic>
</button>
```

**Организация чисел в билете:**
- 6 строк по 15 позиций каждая
- В каждой строке заполнены только 9 позиций
- Числа расположены в порядке возрастания по строкам
- Выбранное число (7) присутствует в найденных билетах

### 5. Навигация по билетам

**Действие**: Клик по кнопке "Другие билеты"

**Процесс:**
- Задержка ~1.5 секунды
- Загружается новая партия из 10 билетов
- Кнопка "Другие билеты" остается доступной

**Бесконечная пагинация:**
- Каждый клик загружает новые 10 билетов
- Билеты не повторяются в рамках одной сессии
- Всегда содержат выбранные числа

## Поток выбора и покупки билета

### 1. Выбор билета для покупки

**Действие**: Клик по билету

**Визуальные изменения:**
- Билет может изменить визуальное состояние (выделение)
- Появляются элементы управления покупкой

**Примечание**: Для неавторизованных пользователей процесс покупки недоступен.

### 2. Процедура оплаты (только для авторизованных)

**Условие**: Пользователь должен быть авторизован

**Появляющиеся элементы:**
- Кнопка "Оплатить кошельком" (если достаточно средств)
- Кнопка с QR-кодом для оплаты
- Информация о стоимости билета

**Селекторы кнопок оплаты:**
```javascript
// Поиск кнопок оплаты
const paymentButtons = Array.from(document.querySelectorAll('button')).filter(btn => {
  const text = btn.textContent.toLowerCase();
  return text.includes('оплатить') || text.includes('купить') || text.includes('qr');
});
```

## Поток аутентификации пользователя

### 1. Определение статуса авторизации

**Неавторизованный пользователь:**
```html
<link href="/auth?targetUrl=%2Fruslotto%2Fgame%3FviewType%3Dfavorite">
  Вход и регистрация
</link>
```

**Авторизованный пользователь:**
```html
<a href="/private/wallet?int=header">0 ₽</a>
<a href="/private/bonus?int=header">46</a>
<a href="/private/tickets/all?int=header">Мои билеты</a>
```

### 2. Процесс авторизации

**Действие**: Клик по "Вход и регистрация"

**Результат**: 
- Переход на страницу авторизации
- После успешного входа возврат на исходную страницу
- Изменение элементов интерфейса на авторизованные

### 3. Работа с балансом

**Отображение баланса:**
```javascript
function getUserBalance() {
  const balanceLink = document.querySelector('a[href="/private/wallet?int=header"]');
  if (balanceLink) {
    const balanceText = balanceLink.textContent.trim(); // "1500 ₽"
    const match = balanceText.match(/(\d+(?:\s\d+)*)\s*₽/);
    return match ? parseInt(match[1].replace(/\s/g, '')) : 0;
  }
  return null; // Не авторизован
}
```

## Поток сброса выбора

### 1. Сброс выбранных чисел

**Действие**: Клик по кнопке "Сбросить"

**Селектор**: `[data-test-id="clear_btn"]`

**Изменения:**
- Все выбранные числа становятся неактивными
- Исчезает блок "Выбранные числа"
- Исчезает кнопка "Показать билеты"
- Исчезает кнопка "Сбросить"
- Возврат к начальному состоянию

## Сравнение с логикой расширения

### Соответствия с кодом расширения

| Функция в коде | Реальное поведение | Статус |
|----------------|-------------------|---------|
| `clickNumbers()` | Выбор чисел работает | ✅ Соответствует |
| `analyzeTicket()` | Структура билета корректна | ✅ Соответствует |
| Поиск по режимам | Режимы "anywhere", "half", "row" применимы | ✅ Соответствует |
| `isUserLoggedIn()` | Проверка авторизации работает | ✅ Соответствует |
| `getUserBalance()` | Получение баланса работает | ✅ Соответствует |

### Расхождения с кодом расширения

| Ожидание в коде | Реальность | Проблема |
|-----------------|------------|----------|
| Кнопка "Очистить" | Кнопка "Сбросить" | Неправильный текст |
| `[data-test-id="show-tickets"]` | `[data-test-id="other_ticket"]` | Неправильный селектор |
| `[data-test-id="other-tickets"]` | `[data-test-id="other_ticket"]` | Неправильный селектор |
| Числа с `data-test-id="number"` в билетах | Числа как `generic` элементы | Неправильная структура |

## Временные характеристики

### Задержки в интерфейсе

| Действие | Время отклика | Описание |
|----------|---------------|----------|
| Выбор числа | Мгновенно | Немедленное изменение состояния |
| "Показать билеты" | ~1 секунда | Загрузка и отображение билетов |
| "Другие билеты" | ~1.5 секунды | Загрузка новой партии |
| Сброс выбора | Мгновенно | Немедленный возврат к начальному состоянию |

### Рекомендации для расширения

**Задержки в коде:**
```javascript
// Текущие задержки в расширении
await new Promise(resolve => setTimeout(resolve, 500)); // После выбора чисел
await new Promise(resolve => setTimeout(resolve, 1000)); // После "Показать билеты"
await new Promise(resolve => setTimeout(resolve, 1500)); // После "Другие билеты"
```

**Оптимальные задержки:**
- После выбора чисел: 250-500мс
- После "Показать билеты": 1000-1500мс  
- После "Другие билеты": 1500-2000мс

## Обработка ошибок и крайних случаев

### Сетевые ошибки

**Симптомы:**
- Кнопки не отвечают на клики
- Билеты не загружаются
- Страница зависает

**Обработка в расширении:**
```javascript
// Проверка доступности кнопок
function waitForButton(selector, timeout = 5000) {
  return new Promise((resolve, reject) => {
    const startTime = Date.now();
    const checkButton = () => {
      const button = document.querySelector(selector);
      if (button && !button.disabled) {
        resolve(button);
      } else if (Date.now() - startTime > timeout) {
        reject(new Error(`Button ${selector} not found or disabled`));
      } else {
        setTimeout(checkButton, 100);
      }
    };
    checkButton();
  });
}
```

### Изменения в структуре сайта

**Мониторинг изменений:**
```javascript
// Проверка актуальности селекторов
function validateSelectors() {
  const criticalSelectors = [
    '[data-test-id="number"]',
    '[data-test-id="other_ticket"]', 
    '[data-test-id="clear_btn"]',
    'button.Ticket_btn__L4SXA'
  ];
  
  return criticalSelectors.every(selector => 
    document.querySelector(selector) !== null
  );
}
```

## Заключение

Пользовательские потоки на сайте Столото в целом соответствуют ожиданиям расширения, но требуют корректировки селекторов и текстов кнопок. Основные проблемы связаны с:

1. **Неточными селекторами** - требуется обновление data-test-id
2. **Неправильными текстами кнопок** - "Сбросить" вместо "Очистить"
3. **Структурой билетов** - числа как generic элементы, а не с data-test-id
4. **Временными задержками** - необходима оптимизация для стабильной работы

Все выявленные расхождения могут быть исправлены без изменения основной логики расширения.