# Пользовательские сценарии работы с сайтом Столото

## Обзор

Данный документ описывает актуальные пользовательские сценарии работы с сайтом Столото для лотереи "Русское лото". Сценарии основаны на тестировании страницы `https://www.stoloto.ru/ruslotto/game?viewType=favorite` с использованием playwright MCP для неавторизованных сценариев.

## Базовые сценарии (неавторизованные пользователи)

### Сценарий 1: Выбор любимых чисел и просмотр билетов

#### Описание
Пользователь выбирает от 1 до 7 любимых чисел и просматривает подходящие билеты.

#### Предусловия
- Пользователь находится на странице выбора любимых чисел
- Пользователь не авторизован

#### Шаги выполнения

1. **Загрузка страницы**
   ```
   URL: https://www.stoloto.ru/ruslotto/game?viewType=favorite
   Ожидаемый результат: Отображается сетка чисел от 1 до 90
   ```

2. **Выбор первого числа**
   ```
   Действие: Клик по кнопке с числом (например, "1")
   Селектор: [data-test-id="number"] или button с текстом "1"
   Ожидаемый результат: 
   - Кнопка становится активной (атрибут [active])
   - Появляется кнопка "Показать билеты"
   ```

3. **Выбор дополнительных чисел (опционально)**
   ```
   Действие: Клик по дополнительным числам (например, "5")
   Ожидаемый результат: 
   - Выбранные числа отмечаются как активные
   - Отображается блок "Выбранные числа" с перечислением
   ```

4. **Просмотр билетов**
   ```
   Действие: Клик по кнопке "Показать билеты"
   Селектор: button с текстом "Показать билеты"
   Ожидаемый результат:
   - Загружается список билетов (обычно 10 штук)
   - Каждый билет содержит 30 чисел (6 строк × 5 чисел)
   - Выбранные числа выделены в билетах
   - Появляется кнопка "Другие билеты"
   ```

5. **Навигация по билетам**
   ```
   Действие: Клик по кнопке "Другие билеты"
   Селектор: button с текстом "Другие билеты"
   Ожидаемый результат: Загружается следующая партия билетов
   ```

#### Структура билета

Каждый билет имеет следующую структуру:
```
Билет №999294043967
┌─────────────────────────────────────────────┐
│ Строка 1: 3  19  24  52  69                 │
│ Строка 2: 1  49  50  77  89                 │
│ Строка 3: 10 38  48  61  87                 │
├─────────────────────────────────────────────┤
│ Строка 4: 12 44  66  70  90                 │
│ Строка 5: 5  13  28  41  53                 │
│ Строка 6: 27 35  55  78  83                 │
└─────────────────────────────────────────────┘
```

#### Возможные ошибки и их обработка

1. **Числа не выбраны**
   ```
   Проблема: Кнопка "Показать билеты" не появляется
   Причина: Не выбрано ни одного числа
   Решение: Выбрать хотя бы одно число от 1 до 90
   ```

2. **Билеты не загружаются**
   ```
   Проблема: После клика "Показать билеты" ничего не происходит
   Причина: Медленное соединение или ошибка сервера
   Решение: Подождать 2-3 секунды, повторить попытку
   ```

3. **Кнопка "Другие билеты" недоступна**
   ```
   Проблема: Нет возможности посмотреть больше билетов
   Причина: Загружены все доступные билеты для выбранных чисел
   Решение: Изменить выбранные числа или их количество
   ```

### Сценарий 2: Сброс выбора и новый поиск

#### Описание
Пользователь сбрасывает текущий выбор чисел и начинает новый поиск.

#### Шаги выполнения

1. **Сброс выбранных чисел**
   ```
   Действие: Клик по кнопке "Сбросить"
   Селектор: button с текстом "Сбросить"
   Ожидаемый результат:
   - Все выбранные числа становятся неактивными
   - Исчезает блок "Выбранные числа"
   - Исчезает кнопка "Показать билеты"
   - Скрывается список билетов (если был открыт)
   ```

2. **Новый выбор чисел**
   ```
   Действие: Выбор новых чисел
   Ожидаемый результат: Процесс повторяется как в Сценарии 1
   ```

### Сценарий 3: Анализ билета на соответствие критериям

#### Описание
Расширение анализирует каждый билет на соответствие выбранным числам в различных режимах.

#### Режимы поиска

1. **Режим "anywhere" (где угодно)**
   ```
   Критерий: Все выбранные числа должны присутствовать в билете
   Пример: Числа 1, 5 найдены в любых позициях билета
   ```

2. **Режим "half" (половина)**
   ```
   Критерий: Все числа в одной половине билета
   - Первая половина: строки 1-3 (числа 1-15 в билете)
   - Вторая половина: строки 4-6 (числа 16-30 в билете)
   ```

3. **Режим "row" (строка)**
   ```
   Критерий: Все числа в одной строке билета
   Пример: Числа 1, 5 находятся в строке 5: "5 13 28 41 53"
   ```

#### Алгоритм анализа

```javascript
// Псевдокод анализа билета
function analyzeTicket(ticket, selectedNumbers, mode) {
  // 1. Извлечение всех чисел из билета
  const ticketNumbers = extractNumbersFromTicket(ticket);
  
  // 2. Группировка по строкам (6 строк × 5 чисел)
  const rows = groupNumbersByRows(ticketNumbers);
  
  // 3. Проверка по режиму
  switch(mode) {
    case 'anywhere':
      return selectedNumbers.every(num => ticketNumbers.includes(num));
    
    case 'half':
      const firstHalf = rows.slice(0, 3).flat();
      const secondHalf = rows.slice(3, 6).flat();
      return selectedNumbers.every(num => firstHalf.includes(num)) ||
             selectedNumbers.every(num => secondHalf.includes(num));
    
    case 'row':
      return rows.some(row => 
        selectedNumbers.every(num => row.includes(num))
      );
  }
}
```

## Авторизованные сценарии

> **Примечание**: Для тестирования авторизованных сценариев требуется browser MCP. При проблемах с подключением к browser MCP необходимо остановиться и попросить исправить соединение.

### Сценарий 4: Проверка авторизации и баланса

#### Описание
Проверка статуса авторизации пользователя и получение информации о балансе.

#### Шаги выполнения

1. **Определение статуса авторизации**
   ```
   Неавторизованное состояние:
   - Присутствует ссылка "Вход и регистрация"
   - Селектор: a[href*="/auth"]
   
   Авторизованное состояние:
   - Присутствуют ссылки на баланс и бонусы
   - Селекторы: 
     * a[href="/private/wallet?int=header"] - баланс
     * a[href="/private/bonus?int=header"] - бонусы
   ```

2. **Получение баланса пользователя**
   ```
   Селектор: a[href="/private/wallet?int=header"]
   Формат текста: "1500 ₽" или "0 ₽"
   Извлечение: Регулярное выражение /(\d+(?:\s\d+)*)\s*₽/
   ```

3. **Получение количества бонусов**
   ```
   Селектор: a[href="/private/bonus?int=header"]
   Формат текста: "46" (только число)
   ```

### Сценарий 5: Автоматическая покупка билетов

#### Описание
Автоматический выбор и покупка подходящих билетов для авторизованных пользователей.

#### Предусловия
- Пользователь авторизован
- На балансе достаточно средств (150 ₽ за билет)

#### Шаги выполнения

1. **Выбор чисел и поиск билетов**
   ```
   Действия: Аналогично Сценарию 1
   ```

2. **Выбор подходящих билетов**
   ```
   Действие: Клик по билетам, соответствующим критериям
   Ожидаемый результат: Билеты добавляются в корзину
   ```

3. **Проверка кнопок оплаты**
   ```
   Ожидаемые кнопки:
   - "Оплатить кошельком" - оплата с баланса
   - QR-код или СБП - альтернативные способы оплаты
   ```

4. **Оплата билетов**
   ```
   Действие: Клик по кнопке "Оплатить кошельком"
   Ожидаемый результат:
   - Списание средств с баланса
   - Подтверждение покупки
   - Обновление счетчика купленных билетов
   ```

5. **Продолжение покупки (если нужно больше билетов)**
   ```
   Действие: Перезагрузка страницы для поиска новых билетов
   Ожидаемый результат: Процесс повторяется до достижения лимита
   ```

#### Ограничения и проверки

1. **Проверка баланса**
   ```javascript
   function hasEnoughFunds(ticketsToBuy) {
     const balance = getUserBalance();
     const required = ticketsToBuy * 150; // 150 ₽ за билет
     return balance >= required;
   }
   ```

2. **Лимиты покупки**
   ```
   - Максимум билетов за сессию: настраивается пользователем
   - Проверка лимита перед каждой покупкой
   - Остановка при достижении лимита
   ```

## Обработка ошибок и восстановление

### Типичные ошибки

1. **Сетевые ошибки**
   ```
   Проблема: Медленная загрузка или таймауты
   Решение: Увеличение времени ожидания, повторные попытки
   ```

2. **Изменение структуры сайта**
   ```
   Проблема: Селекторы не найдены
   Решение: Использование fallback селекторов, поиск по тексту
   ```

3. **Ошибки авторизации**
   ```
   Проблема: Сессия истекла во время работы
   Решение: Проверка статуса авторизации перед каждой операцией
   ```

### Стратегии восстановления

1. **Graceful degradation**
   ```javascript
   // Попытка использования основного селектора
   let element = document.querySelector('[data-test-id="number"]');
   
   // Fallback на поиск по тексту
   if (!element) {
     element = Array.from(document.querySelectorAll('button'))
       .find(btn => btn.textContent.trim() === targetNumber.toString());
   }
   ```

2. **Автоматическое восстановление**
   ```javascript
   // Восстановление после перезагрузки страницы
   function restoreState() {
     const savedState = loadFromStorage();
     if (savedState.isPurchaseMode) {
       // Продолжить покупку с сохраненными параметрами
       continuePurchase(savedState);
     }
   }
   ```

3. **Уведомления пользователя**
   ```javascript
   // Информирование о проблемах
   function showError(message) {
     console.error('Ошибка расширения:', message);
     // Обновление статуса в UI расширения
     updateExtensionStatus('error', message);
   }
   ```

## Производительность и оптимизация

### Рекомендуемые задержки

1. **Между кликами по числам**: 250-1000 мс (случайно)
2. **После клика "Показать билеты"**: 1000-1500 мс
3. **После клика "Другие билеты"**: 1500 мс
4. **После покупки билета**: 5000 мс

### Оптимизация поиска

1. **Пакетная обработка билетов**
   ```javascript
   // Анализ всех билетов на странице перед переходом к следующей
   const tickets = document.querySelectorAll('button[data-ticket]');
   const suitableTickets = [];
   
   for (const ticket of tickets) {
     if (analyzeTicket(ticket, selectedNumbers, mode)) {
       suitableTickets.push(ticket);
     }
   }
   ```

2. **Кэширование результатов**
   ```javascript
   // Сохранение проанализированных билетов
   const analyzedTickets = new Map();
   
   function getCachedAnalysis(ticketId) {
     return analyzedTickets.get(ticketId);
   }
   ```

## Мониторинг и логирование

### Ключевые метрики

1. **Скорость поиска**: билетов в минуту
2. **Успешность покупок**: процент успешных транзакций
3. **Точность анализа**: соответствие найденных билетов критериям

### Логирование событий

```javascript
// Структура лога событий
const eventLog = {
  timestamp: Date.now(),
  action: 'ticket_analysis',
  ticketId: 'Билет №999294043967',
  numbers: [1, 5],
  mode: 'anywhere',
  result: true,
  executionTime: 45 // мс
};
```

## Совместимость и поддержка

### Поддерживаемые браузеры
- Chrome 88+ (Manifest V3)
- Edge 88+
- Другие Chromium-браузеры

### Известные ограничения
1. Работа только на странице выбора любимых чисел
2. Требуется JavaScript для полной функциональности
3. Зависимость от стабильности селекторов сайта

### Планы развития
1. Поддержка других типов лотерей
2. Улучшенная аналитика результатов
3. Интеграция с мобильной версией сайта